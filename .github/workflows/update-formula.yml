name: Update Formula

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Release version (e.g. v1.0.1)"
        required: true

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout tap repo
        uses: actions/checkout@v4

      - name: Update formula
        env:
          VERSION: ${{ inputs.version }}
        run: |
          TAG="$VERSION"
          VERSION_NUM="${TAG#v}"
          TARBALL_URL="https://github.com/nasiridrishi/yank/archive/refs/tags/${TAG}.tar.gz"

          curl -sL "$TARBALL_URL" -o source.tar.gz
          SHA256=$(sha256sum source.tar.gz | awk '{print $1}')
          rm source.tar.gz

          sed -i "s|url \"https://github.com/nasiridrishi/yank/archive/refs/tags/.*\"|url \"${TARBALL_URL}\"|" Formula/yank.rb
          sed -i "0,/sha256 \".*\"/{s|sha256 \".*\"|sha256 \"${SHA256}\"|}" Formula/yank.rb

      - name: Commit and push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Formula/yank.rb
          git diff --cached --quiet && echo "No changes" && exit 0
          git commit -m "Update yank to ${VERSION}"
          git push
